<%- include('header', { title: business ? `Edit ${business.business_name}` : 'Add New Business' }) %>

<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <%- include('sidebar') %>
    
    <!-- Main Content -->
    <div class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
      <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">
          <% if (business) { %>
            <i class="fas fa-building"></i> <%= business.business_name %>
          <% } else { %>
            <i class="fas fa-plus"></i> Add New Business
          <% } %>
        </h1>
        <div class="btn-toolbar mb-2 mb-md-0">
          <a href="/dashboard" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
          </a>
        </div>
      </div>

      <% if (business) { %>
        <!-- Business Overview -->
        <div class="row mb-4">
          <div class="col-md-3">
            <div class="card bg-primary text-white">
              <div class="card-body">
                <div class="d-flex justify-content-between">
                  <div>
                    <h6 class="card-title">Total Orders</h6>
                    <h3 class="mb-0"><%= businessStats.totalOrders %></h3>
                  </div>
                  <div class="align-self-center">
                    <i class="fas fa-shopping-cart fa-2x"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card bg-success text-white">
              <div class="card-body">
                <div class="d-flex justify-content-between">
                  <div>
                    <h6 class="card-title">Completed Orders</h6>
                    <h3 class="mb-0"><%= businessStats.completedOrders %></h3>
                  </div>
                  <div class="align-self-center">
                    <i class="fas fa-check-circle fa-2x"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card bg-warning text-white">
              <div class="card-body">
                <div class="d-flex justify-content-between">
                  <div>
                    <h6 class="card-title">Pending Orders</h6>
                    <h3 class="mb-0"><%= businessStats.pendingOrders %></h3>
                  </div>
                  <div class="align-self-center">
                    <i class="fas fa-clock fa-2x"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card bg-info text-white">
              <div class="card-body">
                <div class="d-flex justify-content-between">
                  <div>
                    <h6 class="card-title">WhatsApp Groups</h6>
                    <h3 class="mb-0"><%= businessGroups.length %></h3>
                  </div>
                  <div class="align-self-center">
                    <i class="fas fa-comments fa-2x"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Business Information -->
        <div class="row">
          <div class="col-md-8">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">Business Information</h5>
              </div>
              <div class="card-body">
                <form id="businessForm">
                  <input type="hidden" name="business_id" value="<%= business.business_id %>">
                  <div class="mb-3">
                    <label for="businessName" class="form-label">Business Name *</label>
                    <input type="text" class="form-control" id="businessName" name="business_name" value="<%= business.business_name %>" required>
                  </div>
                  <div class="mb-3">
                    <label for="businessDescription" class="form-label">Description</label>
                    <textarea class="form-control" id="businessDescription" name="description" rows="3"><%= business.description || '' %></textarea>
                  </div>
                  <div class="row">
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="businessPhone" class="form-label">Business Phone</label>
                        <input type="tel" class="form-control" id="businessPhone" name="phone" value="<%= business.phone || '' %>">
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="businessEmail" class="form-label">Business Email</label>
                        <input type="email" class="form-control" id="businessEmail" name="email" value="<%= business.email || '' %>">
                      </div>
                    </div>
                  </div>
                  <div class="mb-3">
                    <label for="businessAddress" class="form-label">Business Address</label>
                    <textarea class="form-control" id="businessAddress" name="address" rows="2"><%= business.address || '' %></textarea>
                  </div>
                  <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary">
                      <i class="fas fa-save"></i> Save Changes
                    </button>
                    <button type="button" class="btn btn-danger" onclick="deleteBusiness()">
                      <i class="fas fa-trash"></i> Delete Business
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">Business Details</h5>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <label class="form-label">Business ID</label>
                  <input type="text" class="form-control" value="<%= business.business_id %>" readonly>
                </div>
                <div class="mb-3">
                  <label class="form-label">Created</label>
                  <input type="text" class="form-control" value="<%= new Date(business.created_at).toLocaleDateString() %>" readonly>
                </div>
                <div class="mb-3">
                  <label class="form-label">Last Updated</label>
                  <input type="text" class="form-control" value="<%= business.updated_at ? new Date(business.updated_at).toLocaleDateString() : 'Never' %>" readonly>
                </div>
                <div class="alert alert-info">
                  <i class="fas fa-info-circle"></i>
                  <strong>Status:</strong> Active
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- WhatsApp Groups -->
        <div class="card mt-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">WhatsApp Groups</h5>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addGroupModal">
              <i class="fas fa-plus"></i> Add Group
            </button>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table">
                <thead>
                  <tr>
                    <th>Group Name</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th>Created</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <% if (businessGroups && businessGroups.length > 0) { %>
                    <% businessGroups.forEach(group => { %>
                      <tr>
                        <td>
                          <strong><%= group.group_name %></strong>
                          <br>
                          <small class="text-muted"><%= group.group_id %></small>
                        </td>
                        <td>
                          <span class="badge bg-<%= group.group_type === 'sales' ? 'success' : 'info' %>">
                            <%= group.group_type.charAt(0).toUpperCase() + group.group_type.slice(1) %>
                          </span>
                        </td>
                        <td><span class="badge bg-success">Active</span></td>
                        <td><%= new Date(group.created_at).toLocaleDateString() %></td>
                        <td>
                          <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewGroup('<%= group.id %>')">View</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="removeGroup('<%= group.id %>')">Remove</button>
                          </div>
                        </td>
                      </tr>
                    <% }); %>
                  <% } else { %>
                    <tr>
                      <td colspan="5" class="text-center">
                        <div class="alert alert-info mb-0">
                          No WhatsApp groups configured yet.
                          <button class="btn btn-primary btn-sm ms-2" data-bs-toggle="modal" data-bs-target="#addGroupModal">
                            Add Your First Group
                          </button>
                        </div>
                      </td>
                    </tr>
                  <% } %>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Recent Orders -->
        <div class="card mt-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Recent Orders</h5>
            <div class="btn-group">
              <button type="button" class="btn btn-outline-success dropdown-toggle" data-bs-toggle="dropdown">
                <i class="fas fa-download"></i> Export
              </button>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" onclick="exportBusinessOrders('csv')">Export to CSV</a></li>
                <li><a class="dropdown-item" href="#" onclick="exportBusinessOrders('json')">Export to JSON</a></li>
              </ul>
              <a href="/orders?business=<%= business.business_id %>" class="btn btn-outline-primary">
                <i class="fas fa-external-link-alt"></i> View All Orders
              </a>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table">
                <thead>
                  <tr>
                    <th>Order ID</th>
                    <th>Customer</th>
                    <th>Items</th>
                    <th>Status</th>
                    <th>Date</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <% if (recentOrders && recentOrders.length > 0) { %>
                    <% recentOrders.forEach(order => { %>
                      <tr>
                        <td><%= order.order_id %></td>
                        <td><%= order.customer_name %></td>
                        <td><%= order.items ? order.items.length : 0 %> items</td>
                        <td>
                          <span class="badge bg-<%= order.status === 'pending' ? 'warning' : (order.status === 'delivered' ? 'success' : 'secondary') %>">
                            <%= order.status.charAt(0).toUpperCase() + order.status.slice(1) %>
                          </span>
                        </td>
                        <td><%= new Date(order.created_at).toLocaleDateString() %></td>
                        <td>
                          <button class="btn btn-sm btn-outline-primary" onclick="viewOrder('<%= order.id %>')">View</button>
                        </td>
                      </tr>
                    <% }); %>
                  <% } else { %>
                    <tr>
                      <td colspan="6" class="text-center">
                        <div class="alert alert-info mb-0">
                          No orders yet. Orders will appear here when customers place them in your WhatsApp groups.
                        </div>
                      </td>
                    </tr>
                  <% } %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      <% } else { %>
        <!-- Add New Business Form -->
        <div class="row justify-content-center">
          <div class="col-md-8">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">Create New Business</h5>
              </div>
              <div class="card-body">
                <form id="newBusinessForm">
                  <div class="mb-3">
                    <label for="businessName" class="form-label">Business Name *</label>
                    <input type="text" class="form-control" id="businessName" name="business_name" required>
                  </div>
                  <div class="mb-3">
                    <label for="businessDescription" class="form-label">Description</label>
                    <textarea class="form-control" id="businessDescription" name="description" rows="3"></textarea>
                  </div>
                  <div class="row">
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="businessPhone" class="form-label">Business Phone</label>
                        <input type="tel" class="form-control" id="businessPhone" name="phone">
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="businessEmail" class="form-label">Business Email</label>
                        <input type="email" class="form-control" id="businessEmail" name="email">
                      </div>
                    </div>
                  </div>
                  <div class="mb-3">
                    <label for="businessAddress" class="form-label">Business Address</label>
                    <textarea class="form-control" id="businessAddress" name="address" rows="2"></textarea>
                  </div>
                  <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary">
                      <i class="fas fa-plus"></i> Create Business
                    </button>
                    <a href="/dashboard" class="btn btn-secondary">Cancel</a>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      <% } %>
    </div>
  </div>
</div>

<!-- Add Group Modal -->
<div class="modal fade" id="addGroupModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add WhatsApp Group</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="addGroupForm">
          <input type="hidden" name="business_id" value="<%= business ? business.business_id : '' %>">
          <div class="mb-3">
            <label for="groupType" class="form-label">Group Type *</label>
            <select class="form-select" id="groupType" name="group_type" required>
              <option value="">Select group type</option>
              <option value="sales">Sales Group</option>
              <option value="delivery">Delivery Group</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="groupName" class="form-label">Group Name *</label>
            <input type="text" class="form-control" id="groupName" name="group_name" required>
          </div>
          <div class="mb-3">
            <label for="groupId" class="form-label">Group ID *</label>
            <input type="text" class="form-control" id="groupId" name="group_id" required>
            <div class="form-text">Get this by typing /setup in your WhatsApp group</div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="addGroup()">Add Group</button>
      </div>
    </div>
  </div>
</div>

<!-- Group Details Modal -->
<div class="modal fade" id="groupDetailsModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Group Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="groupDetailsContent">
        Loading...
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Order Details Modal -->
<div class="modal fade" id="orderDetailsModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Order Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="orderDetailsContent">
        Loading...
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
  // Business form submission
  document.getElementById('businessForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    try {
      const formData = new FormData(e.target);
      const response = await fetch('/api/businesses/<%= business ? business.business_id : "" %>', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          business_name: formData.get('business_name'),
          description: formData.get('description'),
          phone: formData.get('phone'),
          email: formData.get('email'),
          address: formData.get('address'),
          user_id: '<%= userId %>'
        })
      });
      
      const result = await response.json();
      
      if (response.ok) {
        alert('Business updated successfully!');
        location.reload();
      } else {
        alert('Failed to update business: ' + result.error);
      }
    } catch (error) {
      alert('Error updating business: ' + error.message);
    }
  });

  // New business form submission
  document.getElementById('newBusinessForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    try {
      const formData = new FormData(e.target);
      const response = await fetch('/api/businesses', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          business_name: formData.get('business_name'),
          description: formData.get('description'),
          phone: formData.get('phone'),
          email: formData.get('email'),
          address: formData.get('address'),
          user_id: '<%= userId %>'
        })
      });
      
      const result = await response.json();
      
      if (response.ok) {
        alert('Business created successfully!');
        window.location.href = '/business/' + result.business_id;
      } else {
        alert('Failed to create business: ' + result.error);
      }
    } catch (error) {
      alert('Error creating business: ' + error.message);
    }
  });

  async function deleteBusiness() {
    if (!confirm('Are you sure you want to delete this business? This action cannot be undone and will also delete all associated groups and orders.')) {
      return;
    }
    
    try {
      const response = await fetch('/api/businesses/<%= business ? business.business_id : "" %>?user_id=<%= userId %>', {
        method: 'DELETE'
      });
      
      const result = await response.json();
      
      if (response.ok) {
        alert('Business deleted successfully!');
        window.location.href = '/dashboard';
      } else {
        alert('Failed to delete business: ' + result.error);
      }
    } catch (error) {
      alert('Error deleting business: ' + error.message);
    }
  }

  async function addGroup() {
    const form = document.getElementById('addGroupForm');
    const formData = new FormData(form);
    
    try {
      const response = await fetch('/api/groups', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          business_id: formData.get('business_id'),
          group_type: formData.get('group_type'),
          group_name: formData.get('group_name'),
          group_id: formData.get('group_id'),
          user_id: '<%= userId %>'
        })
      });
      
      const result = await response.json();
      
      if (response.ok) {
        alert('Group added successfully!');
        location.reload();
      } else {
        alert('Failed to add group: ' + result.error);
      }
    } catch (error) {
      alert('Error adding group: ' + error.message);
    }
  }

  function viewGroup(groupId) {
    // Get group details and show in modal
    fetch(`/api/groups/${groupId}?userId=<%= userId %>`)
      .then(response => response.json())
      .then(group => {
        if (group.error) {
          alert('Failed to load group details: ' + group.error);
          return;
        }
        
        // Show group details in a modal
        const modal = new bootstrap.Modal(document.getElementById('groupDetailsModal'));
        const content = document.getElementById('groupDetailsContent');
        
        content.innerHTML = `
          <div class="row">
            <div class="col-md-6">
              <h6>Group Information</h6>
              <table class="table table-sm">
                <tr><td><strong>Group Name:</strong></td><td>${group.group_name}</td></tr>
                <tr><td><strong>Group Type:</strong></td><td><span class="badge bg-${group.group_type === 'sales' ? 'primary' : 'success'}">${group.group_type}</span></td></tr>
                <tr><td><strong>Group ID:</strong></td><td><code>${group.group_id}</code></td></tr>
                <tr><td><strong>Business:</strong></td><td>${group.business_name}</td></tr>
              </table>
            </div>
            <div class="col-md-6">
              <h6>Group Details</h6>
              <table class="table table-sm">
                <tr><td><strong>Created:</strong></td><td>${new Date(group.created_at).toLocaleString()}</td></tr>
                <tr><td><strong>Status:</strong></td><td><span class="badge bg-success">Active</span></td></tr>
                <tr><td><strong>Purpose:</strong></td><td>${group.group_type === 'sales' ? 'Receive new orders from customers' : 'Coordinate deliveries and updates'}</td></tr>
              </table>
            </div>
          </div>
          <div class="alert alert-info mt-3">
            <i class="fas fa-info-circle"></i>
            <strong>Note:</strong> This group is connected to your WhatsApp business. Orders will be automatically sent to the appropriate group based on their status.
          </div>
        `;
        
        modal.show();
      })
      .catch(error => {
        alert('Error loading group details: ' + error.message);
      });
  }

  async function removeGroup(groupId) {
    if (!confirm('Are you sure you want to remove this group?')) {
      return;
    }
    
    try {
      const response = await fetch(`/api/groups/${groupId}?user_id=<%= userId %>`, {
        method: 'DELETE'
      });
      
      if (response.ok) {
        alert('Group removed successfully!');
        location.reload();
      } else {
        alert('Failed to remove group');
      }
    } catch (error) {
      alert('Error removing group: ' + error.message);
    }
  }

  function viewOrder(orderId) {
    // Get order details and show in modal
    fetch(`/api/orders/${orderId}?userId=<%= userId %>`)
      .then(response => response.json())
      .then(order => {
        if (order.error) {
          alert('Failed to load order details: ' + order.error);
          return;
        }
        
        // Show order details in a modal
        const modal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));
        const content = document.getElementById('orderDetailsContent');
        
        // Parse items if it's a JSON string
        let items = [];
        try {
          items = typeof order.items === 'string' ? JSON.parse(order.items) : order.items;
        } catch (e) {
          items = [{ name: order.items, quantity: 1 }];
        }
        
        content.innerHTML = `
          <div class="row">
            <div class="col-md-6">
              <h6>Order Information</h6>
              <table class="table table-sm">
                <tr><td><strong>Order ID:</strong></td><td>${order.order_id}</td></tr>
                <tr><td><strong>Business:</strong></td><td>${order.business_name}</td></tr>
                <tr><td><strong>Status:</strong></td><td><span class="badge bg-${getStatusColor(order.status)}">${order.status}</span></td></tr>
                <tr><td><strong>Created:</strong></td><td>${new Date(order.created_at).toLocaleString()}</td></tr>
                <tr><td><strong>Updated:</strong></td><td>${order.updated_at ? new Date(order.updated_at).toLocaleString() : 'Never'}</td></tr>
              </table>
            </div>
            <div class="col-md-6">
              <h6>Customer Information</h6>
              <table class="table table-sm">
                <tr><td><strong>Name:</strong></td><td>${order.customer_name}</td></tr>
                <tr><td><strong>Phone:</strong></td><td>${order.customer_phone}</td></tr>
                <tr><td><strong>Address:</strong></td><td>${order.address}</td></tr>
                <tr><td><strong>Delivery Date:</strong></td><td>${order.delivery_date ? new Date(order.delivery_date).toLocaleDateString() : 'Not set'}</td></tr>
              </table>
            </div>
          </div>
          <div class="row mt-3">
            <div class="col-12">
              <h6>Order Items</h6>
              <div class="table-responsive">
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>Item</th>
                      <th>Quantity</th>
                      <th>Price</th>
                      <th>Total</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${items.map(item => `
                      <tr>
                        <td>${item.name || item}</td>
                        <td>${item.quantity || 1}</td>
                        <td>$${item.price || '0.00'}</td>
                        <td>$${((item.price || 0) * (item.quantity || 1)).toFixed(2)}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          ${order.notes ? `
            <div class="row mt-3">
              <div class="col-12">
                <h6>Notes</h6>
                <p class="text-muted">${order.notes}</p>
              </div>
            </div>
          ` : ''}
        `;
        
        modal.show();
      })
      .catch(error => {
        alert('Error loading order details: ' + error.message);
      });
  }

  function getStatusColor(status) {
    switch(status) {
      case 'pending': return 'warning';
      case 'processing': return 'info';
      case 'delivered': return 'success';
      case 'cancelled': return 'danger';
      default: return 'secondary';
    }
  }

  function exportBusinessOrders(format = 'csv') {
    const queryParams = new URLSearchParams({
      business_id: '<%= business.business_id %>',
      format: format
    });
    
    window.open(`/api/export/orders?${queryParams}`, '_blank');
  }
</script> 