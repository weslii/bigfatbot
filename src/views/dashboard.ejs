<%- include('layout', { title: 'Business Dashboard' }) %>

<div class="container-fluid mt-4">
  <div class="row">
    <!-- Sidebar -->
    <div class="col-md-3 col-lg-2">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Business Dashboard</h5>
          <hr>
          <ul class="nav flex-column">
            <li class="nav-item">
              <a class="nav-link active" href="/dashboard">Overview</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/orders">Orders</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/groups">Groups</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/settings">Settings</a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="col-md-9 col-lg-10">
      <!-- Business Management -->
      <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">My Businesses</h5>
          <a href="/add-business" class="btn btn-primary">Add New Business</a>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table">
              <thead>
                <tr>
                  <th>Business Name</th>
                  <th>Groups</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% if (businesses && businesses.length > 0) { %>
                  <% businesses.forEach(business => { %>
                    <tr>
                      <td><%= business.business_name %></td>
                      <td>
                        <% const businessGroups = groups.filter(g => g.business_id === business.business_id) %>
                        <span class="badge bg-info"><%= businessGroups.length %> groups</span>
                      </td>
                      <td>
                        <a href="/business/<%= business.business_id %>" class="btn btn-sm btn-outline-primary">Manage</a>
                        <a href="/setup-group?businessId=<%= business.business_id %>" class="btn btn-sm btn-outline-success">Add Group</a>
                      </td>
                    </tr>
                  <% }); %>
                <% } else { %>
                  <tr>
                    <td colspan="3" class="text-center">
                      <div class="alert alert-info mb-0">
                        No businesses yet. <a href="/add-business">Create your first business</a> to get started.
                      </div>
                    </td>
                  </tr>
                <% } %>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Stats Cards -->
      <div class="row mb-4">
        <div class="col-md-4">
          <div class="card bg-primary text-white">
            <div class="card-body">
              <h5 class="card-title">Total Orders</h5>
              <h2 class="card-text"><%= orderStats ? orderStats.totalOrders : 0 %></h2>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card bg-success text-white">
            <div class="card-body">
              <h5 class="card-title">Active Orders</h5>
              <h2 class="card-text"><%= orderStats ? orderStats.activeOrders : 0 %></h2>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card bg-info text-white">
            <div class="card-body">
              <h5 class="card-title">Completed Orders</h5>
              <h2 class="card-text"><%= orderStats ? orderStats.completedOrders : 0 %></h2>
            </div>
          </div>
        </div>
      </div>

      <!-- Groups Status -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">WhatsApp Groups</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table">
              <thead>
                <tr>
                  <th>Business</th>
                  <th>Group Name</th>
                  <th>Type</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% if (groups && groups.length > 0) { %>
                  <% groups.forEach(group => { %>
                    <tr>
                      <td><%= group.business_name %></td>
                      <td><%= group.group_name %></td>
                      <td><%= group.group_type %></td>
                      <td>
                        <span class="badge bg-success">Active</span>
                      </td>
                      <td>
                        <button class="btn btn-sm btn-outline-primary">View Details</button>
                      </td>
                    </tr>
                  <% }); %>
                <% } else { %>
                  <tr>
                    <td colspan="5" class="text-center">
                      <div class="alert alert-info mb-0">
                        No groups configured yet. Please complete the setup process.
                      </div>
                    </td>
                  </tr>
                <% } %>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Recent Orders -->
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Recent Orders</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table">
              <thead>
                <tr>
                  <th>Order ID</th>
                  <th>Business</th>
                  <th>Customer</th>
                  <th>Items</th>
                  <th>Status</th>
                  <th>Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% if (recentOrders && recentOrders.length > 0) { %>
                  <% recentOrders.forEach(order => { %>
                    <tr>
                      <td><%= order.id.substring(0, 8) %>...</td>
                      <td><%= order.business_name %></td>
                      <td><%= order.customer_name %></td>
                      <td><%= order.items ? order.items.length : 0 %> items</td>
                      <td>
                        <span class="badge bg-<%= order.status === 'pending' ? 'warning' : (order.status === 'delivered' ? 'success' : 'secondary') %>">
                          <%= order.status.charAt(0).toUpperCase() + order.status.slice(1) %>
                        </span>
                      </td>
                      <td><%= new Date(order.created_at).toLocaleDateString() %></td>
                      <td>
                        <button class="btn btn-sm btn-outline-primary">View Details</button>
                      </td>
                    </tr>
                  <% }); %>
                <% } else { %>
                  <tr>
                    <td colspan="7" class="text-center">
                      <div class="alert alert-info mb-0">
                        No orders yet. Orders will appear here when customers place them in your WhatsApp group.
                      </div>
                    </td>
                  </tr>
                <% } %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Stats Modal -->
<div class="modal fade" id="statsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Group Statistics</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="statsContent">
                    Loading statistics...
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    async function showGroupStats(groupId) {
        const modal = new bootstrap.Modal(document.getElementById('statsModal'));
        modal.show();
        
        try {
            const response = await fetch(`/api/group-stats?groupId=${groupId}`);
            const data = await response.json();
            
            document.getElementById('statsContent').innerHTML = `
                <div class="row">
                    <div class="col-6">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6>Total Orders</h6>
                                <h3>${data.totalOrders}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6>Pending Orders</h6>
                                <h3>${data.pendingOrders}</h3>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <h6>Recent Activity</h6>
                    <ul class="list-group">
                        ${data.recentActivity.map(activity => `
                            <li class="list-group-item">
                                ${activity.description}
                                <small class="text-muted float-end">${activity.time}</small>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `;
        } catch (error) {
            document.getElementById('statsContent').innerHTML = `
                <div class="alert alert-danger">
                    Failed to load statistics. Please try again.
                </div>
            `;
        }
    }

    async function removeGroup(groupId) {
        if (!confirm('Are you sure you want to remove this group? This action cannot be undone.')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/remove-group?groupId=${groupId}`, {
                method: 'POST'
            });
            
            if (response.ok) {
                location.reload();
            } else {
                alert('Failed to remove group. Please try again.');
            }
        } catch (error) {
            alert('An error occurred. Please try again.');
        }
    }
</script> 