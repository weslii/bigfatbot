<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Groups Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="/css/groups-dashboard.css">
</head>
<body>

    <header class="header">
        <div class="header-content">
            <div class="header-left">
                <a href="/dashboard" class="logo-section">
                    <div class="logo-icon"><i class="fas fa-users"></i></div>
                    <div class="logo-text"><span class="main-title">Groups</span></div>
                </a>
            </div>
            <div class="header-right">
                <a href="/dashboard" class="nav-link">Dashboard</a>
                <a href="/orders" class="nav-link">Orders</a>
                <a href="/groups" class="nav-link active">Groups</a>
                <a href="/businesses" class="nav-link">Businesses</a>
                <button class="btn btn-icon" id="theme-toggle" aria-label="Toggle Theme">
                    <i class="fas fa-sun"></i><i class="fas fa-moon" style="display: none;"></i>
                </button>
                <div class="dropdown">
                    <button class="btn btn-icon" id="profileDropdown"><i class="fas fa-user"></i></button>
                    <div class="dropdown-content" id="profileMenu">
                        <a href="/settings" class="dropdown-item"><i class="fas fa-cog"></i> Settings</a>
                        <form action="/logout" method="post" class="dropdown-item" style="padding: 0; margin: 0;">
                            <button type="submit" style="all: unset; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; width: 100%;"><i class="fas fa-sign-out-alt"></i> Logout</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="main-content">
        <div class="page-header">
            <div>
                <h1 class="page-title">Groups Overview</h1>
                <p class="page-subtitle">Manage your WhatsApp sales and delivery groups.</p>
            </div>
            <div class="header-actions-right">
                <button class="btn btn-primary" id="openAddGroupModal"><i class="fas fa-plus"></i> Add New Group</button>
            </div>
        </div>

        <% const totalGroups = groups.length; %>
        <% const activeBusinesses = new Set(groups.map(g => g.business_id)).size; %>
        <div class="kpi-grid">
            <div class="content-card kpi-card scroll-reveal">
                <div class="kpi-icon"><i class="fas fa-comments"></i></div>
                <div class="kpi-info">
                    <h3><%= totalGroups %></h3>
                    <p>Total Groups</p>
                </div>
            </div>
            <div class="content-card kpi-card scroll-reveal" style="--delay: 0.1s;">
                <div class="kpi-icon"><i class="fas fa-store"></i></div>
                <div class="kpi-info">
                    <h3><%= activeBusinesses %></h3>
                    <p>Active Businesses</p>
                </div>
            </div>
             <div class="content-card kpi-card scroll-reveal" style="--delay: 0.2s;">
                <div class="kpi-icon"><i class="fas fa-arrow-up"></i></div>
                <div class="kpi-info">
                     <h3><%= groups.filter(g => g.group_type === 'sales').length %></h3>
                    <p>Sales Groups</p>
                </div>
            </div>
             <div class="content-card kpi-card scroll-reveal" style="--delay: 0.3s;">
                <div class="kpi-icon"><i class="fas fa-truck"></i></div>
                <div class="kpi-info">
                     <h3><%= groups.filter(g => g.group_type === 'delivery').length %></h3>
                    <p>Delivery Groups</p>
                </div>
            </div>
        </div>

        <div class="content-card scroll-reveal" style="--delay: 0.4s;">
            <div class="card-header">
                <h2 class="card-title"><i class="fas fa-list-alt"></i> All Groups</h2>
                <div class="filters-form">
                    <div class="form-group">
                        <label for="businessFilter" class="form-label">Filter by Business</label>
                        <select id="businessFilter" class="form-select">
                            <option value="">All Businesses</option>
                             <% businesses.forEach(business => { %>
                              <option value="<%= business.business_id %>"><%= business.business_name %></option>
                            <% }); %>
                        </select>
                    </div>
                     <div class="form-group">
                        <label for="typeFilter" class="form-label">Filter by Type</label>
                        <select id="typeFilter" class="form-select">
                            <option value="">All Types</option>
                            <option value="sales">Sales</option>
                            <option value="delivery">Delivery</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="card-content">
                <div class="table-container">
                    <table class="data-table" id="groupsTable">
                        <thead>
                            <tr>
                                <th>Business</th>
                                <th>Group Name</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% if (groups && groups.length > 0) { %>
                                <% groups.forEach(group => { %>
                                    <tr data-business="<%= group.business_id %>" data-type="<%= group.group_type %>">
                                        <td>
                                            <div class="business-info">
                                                <div class="business-avatar"><%= group.business_name.charAt(0).toUpperCase() %></div>
                                                <span><%= group.business_name %></span>
                                            </div>
                                        </td>
                                        <td>
                                            <strong><%= group.group_name %></strong><br>
                                            <small class="text-muted"><%= group.group_id %></small>
                                        </td>
                                        <td><span class="group-type-badge <%= group.group_type %>"><%= group.group_type %></span></td>
                                        <td>
                                            <span class="status-badge <%= group.is_active ? 'active' : 'inactive' %>">
                                                <%= group.is_active ? 'Active' : 'Inactive' %>
                                            </span>
                                        </td>
                                        <td><%= new Date(group.created_at).toLocaleDateString() %></td>
                                        <td>
                                            <div class="btn-group">
                                                <button class="btn btn-sm btn-outline" onclick="removeGroup('<%= group.id %>')"><i class="fas fa-trash"></i> Remove</button>
                                            </div>
                                        </td>
                                    </tr>
                                <% }); %>
                            <% } else { %>
                                <tr>
                                    <td colspan="6">
                                        <div class="no-results">
                                            <i class="fas fa-comments"></i>
                                            <h5>No Groups Found</h5>
                                            <p>Get started by adding your first group.</p>
                                            <button class="btn btn-primary" id="addFirstGroupBtn"><i class="fas fa-plus"></i> Add Group</button>
                                        </div>
                                    </td>
                                </tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Group Modal -->
    <div class="modal-overlay" id="addGroupModal">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New WhatsApp Group</h5>
                <button type="button" class="close-modal" id="closeAddGroupModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addGroupForm">
                    <input type="hidden" name="user_id" value="<%= userId %>">
                    <div class="form-group mb-3">
                        <label for="businessSelect" class="form-label">Business *</label>
                        <select class="form-select" id="businessSelect" name="business_id" required>
                             <option value="" disabled selected>Select a business</option>
                             <% businesses.forEach(business => { %>
                                <% 
                                    const businessGroups = groups.filter(g => g.business_id === business.business_id);
                                    const hasSales = businessGroups.some(g => g.group_type === 'sales');
                                    const hasDelivery = businessGroups.some(g => g.group_type === 'delivery');
                                    const isAtLimit = hasSales && hasDelivery;
                                %>
                                <option value="<%= business.business_id %>" data-has-sales="<%= hasSales %>" data-has-delivery="<%= hasDelivery %>" <%= isAtLimit ? 'disabled' : '' %>>
                                    <%= business.business_name %>
                                </option>
                            <% }); %>
                        </select>
                    </div>
                     <div class="form-group mb-3">
                        <label for="groupType" class="form-label">Group Type *</label>
                        <select class="form-select" id="groupType" name="group_type" required>
                            <option value="" disabled selected>Select group type</option>
                            <option value="sales">Sales Group</option>
                            <option value="delivery">Delivery Group</option>
                        </select>
                    </div>
                    <div class="form-group mb-3">
                        <label for="groupName" class="form-label">Group Name *</label>
                        <input type="text" class="form-input" id="groupName" name="group_name" required>
                    </div>
                    <div class="form-group mb-3">
                        <label for="groupId" class="form-label">Group ID *</label>
                        <input type="text" class="form-input" id="groupId" name="group_id" required placeholder="e.g., 12036302...-1619...@g.us">
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Add Group</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Theme toggle
            const themeToggle = document.getElementById('theme-toggle');
            const html = document.documentElement;
            const sunIcon = themeToggle.querySelector('.fa-sun');
            const moonIcon = themeToggle.querySelector('.fa-moon');

            function applyTheme(theme) {
                html.setAttribute('data-theme', theme);
                if (theme === 'dark') {
                    sunIcon.style.display = 'none';
                    moonIcon.style.display = 'inline-block';
                } else {
                    sunIcon.style.display = 'inline-block';
                    moonIcon.style.display = 'none';
                }
            }

            const savedTheme = localStorage.getItem('theme') || 'light';
            applyTheme(savedTheme);

            themeToggle.addEventListener('click', () => {
                const newTheme = html.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
                localStorage.setItem('theme', newTheme);
                applyTheme(newTheme);
            });

            // Dropdown
             function setupDropdown(buttonId, menuId) {
                const dropdownBtn = document.getElementById(buttonId);
                const dropdownMenu = document.getElementById(menuId);

                if (dropdownBtn && dropdownMenu) {
                    dropdownBtn.addEventListener('click', (event) => {
                        event.stopPropagation();
                        document.querySelectorAll('.dropdown-content.show').forEach(menu => {
                            if (menu.id !== menuId) menu.classList.remove('show');
                        });
                        dropdownMenu.classList.toggle('show');
                    });
                }
            }
            setupDropdown('profileDropdown', 'profileMenu');
            window.addEventListener('click', () => document.querySelectorAll('.dropdown-content.show').forEach(m => m.classList.remove('show')));

            // Modal
            const modal = document.getElementById('addGroupModal');
            const openModalBtn = document.getElementById('openAddGroupModal');
            const closeModalBtn = document.getElementById('closeAddGroupModal');
            const addFirstGroupBtn = document.getElementById('addFirstGroupBtn');
            
            function showModal() { modal.classList.add('show'); }
            function hideModal() { modal.classList.remove('show'); }

            if(openModalBtn) openModalBtn.addEventListener('click', showModal);
            if(addFirstGroupBtn) addFirstGroupBtn.addEventListener('click', showModal);
            if(closeModalBtn) closeModalBtn.addEventListener('click', hideModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) hideModal();
            });

            // Filtering
            const businessFilter = document.getElementById('businessFilter');
            const typeFilter = document.getElementById('typeFilter');
            const groupsTable = document.getElementById('groupsTable').getElementsByTagName('tbody')[0];

            function filterGroups() {
                const businessValue = businessFilter.value;
                const typeValue = typeFilter.value;
                for (let row of groupsTable.rows) {
                    const rowBusiness = row.getAttribute('data-business');
                    const rowType = row.getAttribute('data-type');
                    const businessMatch = !businessValue || rowBusiness === businessValue;
                    const typeMatch = !typeValue || rowType === typeValue;
                    row.style.display = businessMatch && typeMatch ? '' : 'none';
                }
            }
            if(businessFilter) businessFilter.addEventListener('change', filterGroups);
            if(typeFilter) typeFilter.addEventListener('change', filterGroups);
            
            // Add Group Form Submission
            const addGroupForm = document.getElementById('addGroupForm');
            addGroupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(addGroupForm);
                const data = Object.fromEntries(formData.entries());
                
                try {
                    const response = await fetch('/api/groups', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    const result = await response.json();
                    if(response.ok) {
                        window.location.reload();
                    } else {
                        alert('Error: ' + result.error);
                    }
                } catch (error) {
                    alert('An unexpected error occurred.');
                }
            });

            // Remove Group
            window.removeGroup = async (groupId) => {
                if(confirm('Are you sure you want to remove this group?')) {
                    try {
                         const response = await fetch(`/api/groups/${groupId}?userId=<%= userId %>`, {
                            method: 'DELETE'
                        });
                        const result = await response.json();
                        if(response.ok) {
                            window.location.reload();
                        } else {
                            alert('Error: ' + result.error);
                        }
                    } catch(error) {
                         alert('An unexpected error occurred.');
                    }
                }
            }
        });
    </script>
</body>
</html> 