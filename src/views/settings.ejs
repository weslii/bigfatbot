<%- include('header', { title: 'Settings' }) %>

<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <%- include('sidebar') %>
    
    <!-- Main Content -->
    <div class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
      <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Settings</h1>
      </div>

      <!-- Settings Navigation -->
      <ul class="nav nav-tabs mb-4" id="settingsTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" type="button" role="tab">
            <i class="fas fa-user"></i> Profile
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="account-tab" data-bs-toggle="tab" data-bs-target="#account" type="button" role="tab">
            <i class="fas fa-shield-alt"></i> Account
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="notifications-tab" data-bs-toggle="tab" data-bs-target="#notifications" type="button" role="tab">
            <i class="fas fa-bell"></i> Notifications
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="businesses-tab" data-bs-toggle="tab" data-bs-target="#businesses" type="button" role="tab">
            <i class="fas fa-building"></i> Businesses
          </button>
        </li>
      </ul>

      <!-- Tab Content -->
      <div class="tab-content" id="settingsTabContent">
        <!-- Profile Tab -->
        <div class="tab-pane fade show active" id="profile" role="tabpanel">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">Profile Information</h5>
            </div>
            <div class="card-body">
              <form id="profileForm">
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="fullName" class="form-label">Full Name *</label>
                      <input type="text" class="form-control" id="fullName" name="full_name" value="<%= user.full_name %>" required>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="email" class="form-label">Email Address *</label>
                      <input type="email" class="form-control" id="email" name="email" value="<%= user.email %>" required>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="phone" class="form-label">Phone Number</label>
                      <input type="tel" class="form-control" id="phone" name="phone" value="<%= user.phone || user.phone_number || '' %>">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="timezone" class="form-label">Timezone</label>
                      <select class="form-select" id="timezone" name="timezone">
                        <option value="UTC" <%= (user.timezone || 'UTC') === 'UTC' ? 'selected' : '' %>>UTC</option>
                        <option value="America/New_York" <%= (user.timezone || 'UTC') === 'America/New_York' ? 'selected' : '' %>>Eastern Time</option>
                        <option value="America/Chicago" <%= (user.timezone || 'UTC') === 'America/Chicago' ? 'selected' : '' %>>Central Time</option>
                        <option value="America/Denver" <%= (user.timezone || 'UTC') === 'America/Denver' ? 'selected' : '' %>>Mountain Time</option>
                        <option value="America/Los_Angeles" <%= (user.timezone || 'UTC') === 'America/Los_Angeles' ? 'selected' : '' %>>Pacific Time</option>
                        <option value="Europe/London" <%= (user.timezone || 'UTC') === 'Europe/London' ? 'selected' : '' %>>London</option>
                        <option value="Europe/Paris" <%= (user.timezone || 'UTC') === 'Europe/Paris' ? 'selected' : '' %>>Paris</option>
                        <option value="Asia/Tokyo" <%= (user.timezone || 'UTC') === 'Asia/Tokyo' ? 'selected' : '' %>>Tokyo</option>
                        <option value="Asia/Shanghai" <%= (user.timezone || 'UTC') === 'Asia/Shanghai' ? 'selected' : '' %>>Shanghai</option>
                      </select>
                    </div>
                  </div>
                </div>
                <div class="mb-3">
                  <label for="address" class="form-label">Address</label>
                  <textarea class="form-control" id="address" name="address" rows="3"><%= user.address || '' %></textarea>
                </div>
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-save"></i> Save Profile
                </button>
              </form>
            </div>
          </div>
        </div>

        <!-- Account Tab -->
        <div class="tab-pane fade" id="account" role="tabpanel">
          <div class="row">
            <div class="col-md-6">
              <div class="card">
                <div class="card-header">
                  <h5 class="mb-0">Change Password</h5>
                </div>
                <div class="card-body">
                  <form id="passwordForm">
                    <div class="mb-3">
                      <label for="currentPassword" class="form-label">Current Password *</label>
                      <input type="password" class="form-control" id="currentPassword" name="current_password" required>
                    </div>
                    <div class="mb-3">
                      <label for="newPassword" class="form-label">New Password *</label>
                      <input type="password" class="form-control" id="newPassword" name="new_password" required>
                      <div class="form-text">Password must be at least 8 characters long</div>
                    </div>
                    <div class="mb-3">
                      <label for="confirmPassword" class="form-label">Confirm New Password *</label>
                      <input type="password" class="form-control" id="confirmPassword" name="confirm_password" required>
                    </div>
                    <button type="submit" class="btn btn-warning">
                      <i class="fas fa-key"></i> Change Password
                    </button>
                  </form>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card">
                <div class="card-header">
                  <h5 class="mb-0">Account Information</h5>
                </div>
                <div class="card-body">
                  <div class="mb-3">
                    <label class="form-label">Account ID</label>
                    <input type="text" class="form-control" value="<%= user.id %>" readonly>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Member Since</label>
                    <input type="text" class="form-control" value="<%= new Date(user.created_at).toLocaleDateString() %>" readonly>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Last Login</label>
                    <input type="text" class="form-control" value="<%= user.last_login ? new Date(user.last_login).toLocaleString() : 'Never' %>" readonly>
                  </div>
                  <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>Account Status:</strong> Active
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Notifications Tab -->
        <div class="tab-pane fade" id="notifications" role="tabpanel">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">Notification Preferences</h5>
            </div>
            <div class="card-body">
              <form id="notificationsForm">
                <div class="mb-4">
                  <h6>Email Notifications</h6>
                  <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="emailNewOrders" name="email_new_orders" <%= (user.email_new_orders !== false) ? 'checked' : '' %>>
                    <label class="form-check-label" for="emailNewOrders">
                      New order notifications
                    </label>
                  </div>
                  <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="emailDailyReports" name="email_daily_reports" <%= user.email_daily_reports ? 'checked' : '' %>>
                    <label class="form-check-label" for="emailDailyReports">
                      Daily order reports
                    </label>
                  </div>
                  <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="emailWeeklyReports" name="email_weekly_reports" <%= user.email_weekly_reports ? 'checked' : '' %>>
                    <label class="form-check-label" for="emailWeeklyReports">
                      Weekly summary reports
                    </label>
                  </div>
                </div>
                <div class="mb-4">
                  <h6>WhatsApp Notifications</h6>
                  <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="whatsappNewOrders" name="whatsapp_new_orders" <%= (user.whatsapp_new_orders !== false) ? 'checked' : '' %>>
                    <label class="form-check-label" for="whatsappNewOrders">
                      New order alerts in WhatsApp groups
                    </label>
                  </div>
                  <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="whatsappReminders" name="whatsapp_reminders" <%= (user.whatsapp_reminders !== false) ? 'checked' : '' %>>
                    <label class="form-check-label" for="whatsappReminders">
                      Pending order reminders
                    </label>
                  </div>
                </div>
                <div class="mb-4">
                  <h6>Dashboard Notifications</h6>
                  <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="dashboardAlerts" name="dashboard_alerts" <%= (user.dashboard_alerts !== false) ? 'checked' : '' %>>
                    <label class="form-check-label" for="dashboardAlerts">
                      Show alerts on dashboard
                    </label>
                  </div>
                </div>
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-save"></i> Save Preferences
                </button>
              </form>
            </div>
          </div>
        </div>

        <!-- Businesses Tab -->
        <div class="tab-pane fade" id="businesses" role="tabpanel">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">My Businesses</h5>
              <a href="/add-business" class="btn btn-primary">
                <i class="fas fa-plus"></i> Add New Business
              </a>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table">
                  <thead>
                    <tr>
                      <th>Business Name</th>
                      <th>Groups</th>
                      <th>Orders</th>
                      <th>Created</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% if (businesses && businesses.length > 0) { %>
                      <% businesses.forEach(business => { %>
                        <% 
                          const businessGroups = groups.filter(g => g.business_id === business.business_id);
                          const businessOrders = orders.filter(o => o.business_id === business.business_id);
                        %>
                        <tr>
                          <td>
                            <strong><%= business.business_name %></strong>
                          </td>
                          <td>
                            <span class="badge bg-info"><%= businessGroups.length %> groups</span>
                          </td>
                          <td>
                            <span class="badge bg-secondary"><%= businessOrders.length %> orders</span>
                          </td>
                          <td>
                            <%= new Date(business.created_at || Date.now()).toLocaleDateString() %>
                          </td>
                          <td>
                            <div class="btn-group" role="group">
                              <button class="btn btn-sm btn-outline-primary" onclick="editBusiness('<%= business.business_id %>')">
                                <i class="fas fa-edit"></i> Edit
                              </button>
                              <button class="btn btn-sm btn-outline-danger" onclick="deleteBusiness('<%= business.business_id %>')">
                                <i class="fas fa-trash"></i> Delete
                              </button>
                            </div>
                          </td>
                        </tr>
                      <% }); %>
                    <% } else { %>
                      <tr>
                        <td colspan="5" class="text-center">
                          <div class="alert alert-info mb-0">
                            No businesses yet. <a href="/add-business">Create your first business</a> to get started.
                          </div>
                        </td>
                      </tr>
                    <% } %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Profile form submission
  document.getElementById('profileForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    try {
      const formData = new FormData(e.target);
      const response = await fetch('/api/settings/profile', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          full_name: formData.get('full_name'),
          email: formData.get('email'),
          phone: formData.get('phone'),
          timezone: formData.get('timezone'),
          address: formData.get('address'),
          user_id: '<%= user.id %>'
        })
      });
      
      const result = await response.json();
      
      if (response.ok) {
        alert('Profile updated successfully!');
        location.reload();
      } else {
        alert('Failed to update profile: ' + result.error);
      }
    } catch (error) {
      alert('Error updating profile: ' + error.message);
    }
  });

  // Password form submission
  document.getElementById('passwordForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    if (newPassword !== confirmPassword) {
      alert('New passwords do not match!');
      return;
    }
    
    if (newPassword.length < 8) {
      alert('Password must be at least 8 characters long!');
      return;
    }
    
    try {
      const formData = new FormData(e.target);
      const response = await fetch('/api/settings/password', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          current_password: formData.get('current_password'),
          new_password: formData.get('new_password'),
          user_id: '<%= user.id %>'
        })
      });
      
      const result = await response.json();
      
      if (response.ok) {
        alert('Password changed successfully!');
        e.target.reset();
      } else {
        alert('Failed to change password: ' + result.error);
      }
    } catch (error) {
      alert('Error changing password: ' + error.message);
    }
  });

  // Notifications form submission
  document.getElementById('notificationsForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    try {
      const formData = new FormData(e.target);
      const response = await fetch('/api/settings/notifications', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          email_new_orders: formData.get('email_new_orders') === 'on',
          email_daily_reports: formData.get('email_daily_reports') === 'on',
          email_weekly_reports: formData.get('email_weekly_reports') === 'on',
          whatsapp_new_orders: formData.get('whatsapp_new_orders') === 'on',
          whatsapp_reminders: formData.get('whatsapp_reminders') === 'on',
          dashboard_alerts: formData.get('dashboard_alerts') === 'on',
          user_id: '<%= user.id %>'
        })
      });
      
      const result = await response.json();
      
      if (response.ok) {
        alert('Notification preferences saved!');
      } else {
        alert('Failed to save preferences: ' + result.error);
      }
    } catch (error) {
      alert('Error saving preferences: ' + error.message);
    }
  });

  function editBusiness(businessId) {
    // Redirect to business edit page
    window.location.href = `/business/${businessId}`;
  }

  function deleteBusiness(businessId) {
    if (confirm('Are you sure you want to delete this business? This action cannot be undone and will also delete all associated groups and orders.')) {
      // Call the delete API
      fetch(`/api/businesses/${businessId}?user_id=<%= user.id %>`, {
        method: 'DELETE'
      })
      .then(response => response.json())
      .then(result => {
        if (result.success) {
          alert('Business deleted successfully!');
          location.reload();
        } else {
          alert('Failed to delete business: ' + result.error);
        }
      })
      .catch(error => {
        alert('Error deleting business: ' + error.message);
      });
    }
  }
</script> 