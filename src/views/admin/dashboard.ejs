<%- include('../layout', { title: 'Admin Dashboard' }) %>

<div class="container-fluid mt-4 pastel-blue-bg">
  <div class="row">
    <!-- Sidebar -->
    <div class="col-md-3 col-lg-2">
      <div class="card pastel-blue-sidebar">
        <div class="card-body">
          <h5 class="card-title text-dark">Welcome, <%= admin.username %></h5>
          <hr>
          <ul class="nav flex-column">
            <li class="nav-item">
              <a class="nav-link active" href="/admin/dashboard">Dashboard</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/admin/businesses">Businesses</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/admin/orders">Orders</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/admin/users">Users</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/admin/admins">Admins</a>
            </li>
            <li class="nav-item">
              <a class="nav-link text-danger" href="/admin/logout">Logout</a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="col-md-9 col-lg-10">
      <!-- Stats Cards -->
      <div class="row mb-4">
        <div class="col-md-4">
          <div class="card pastel-blue-card text-dark">
            <div class="card-body">
              <h5 class="card-title">Total Businesses</h5>
              <h2 class="card-text"><%= stats.totalBusinesses %></h2>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card pastel-blue-card text-dark">
            <div class="card-body">
              <h5 class="card-title">Active Orders</h5>
              <h2 class="card-text"><%= stats.activeOrders %></h2>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card pastel-blue-card text-dark">
            <div class="card-body">
              <h5 class="card-title">Total Users</h5>
              <h2 class="card-text"><%= stats.totalUsers %></h2>
            </div>
          </div>
        </div>
      </div>

      <!-- Recent Orders -->
      <div class="card mb-4 pastel-blue-card text-dark">
        <div class="card-header">
          <h5 class="mb-0">Recent Orders</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table">
              <thead>
                <tr>
                  <th>Order ID</th>
                  <th>Business</th>
                  <th>Customer</th>
                  <th>Status</th>
                  <th>Date</th>
                </tr>
              </thead>
              <tbody>
                <% orders.forEach(order => { %>
                  <tr>
                    <td><%= order.order_id %></td>
                    <td><%= order.business_name %></td>
                    <td><%= order.customer_name %></td>
                    <td>
                      <span class="badge bg-<%= order.status === 'completed' ? 'success' : 'warning' %>">
                        <%= order.status %>
                      </span>
                    </td>
                    <td><%= new Date(order.created_at).toLocaleDateString() %></td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Active Businesses -->
      <div class="card pastel-blue-card text-dark">
        <div class="card-header">
          <h5 class="mb-0">Active Businesses</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table">
              <thead>
                <tr>
                  <th>Business Name</th>
                  <th>Owner</th>
                  <th>Groups</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                <% businesses.forEach(business => { %>
                  <tr>
                    <td><%= business.business_name %></td>
                    <td><%= business.owner_name %></td>
                    <td><%= business.total_groups %></td>
                    <td>
                      <span class="badge bg-success">Active</span>
                    </td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- WhatsApp Bot Management -->
      <div class="card mt-4 pastel-blue-card text-dark">
        <div class="card-header">
          <h5 class="mb-0">WhatsApp Bot Management</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <h6>Change Bot Number</h6>
              <p class="text-muted">Use this to change the WhatsApp number the bot uses. You'll need to restart the bot after changing.</p>
              <button id="changeNumberBtn" class="btn btn-warning">
                <i class="fas fa-phone"></i> Change WhatsApp Number
              </button>
            </div>
            <div class="col-md-6">
              <h6>Current Status</h6>
              <p class="text-muted">Bot status and connection information will appear here.</p>
              <div id="botStatus" class="alert alert-info">
                <i class="fas fa-info-circle"></i> Bot status monitoring not implemented yet.
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Add active state to current page in sidebar
document.addEventListener('DOMContentLoaded', function() {
  const currentPath = window.location.pathname;
  const navLinks = document.querySelectorAll('.nav-link');
  
  navLinks.forEach(link => {
    if (link.getAttribute('href') === currentPath) {
      link.classList.add('active');
    } else {
      link.classList.remove('active');
    }
  });

  // WhatsApp number change functionality
  const changeNumberBtn = document.getElementById('changeNumberBtn');
  if (changeNumberBtn) {
    changeNumberBtn.addEventListener('click', async function() {
      if (confirm('Are you sure you want to change the WhatsApp bot number? This will log out the current session and require a restart.')) {
        try {
          changeNumberBtn.disabled = true;
          changeNumberBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Changing...';
          
          const response = await fetch('/api/whatsapp/change-number', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              userId: '<%= admin.id %>' // Use admin ID
            })
          });
          
          const result = await response.json();
          
          if (result.success) {
            alert('WhatsApp number change initiated successfully! Please restart the bot to complete the process.');
          } else {
            alert('Error: ' + (result.error || 'Failed to change WhatsApp number'));
          }
        } catch (error) {
          console.error('Error:', error);
          alert('Error: Failed to change WhatsApp number');
        } finally {
          changeNumberBtn.disabled = false;
          changeNumberBtn.innerHTML = '<i class="fas fa-phone"></i> Change WhatsApp Number';
        }
      }
    });
  }
});
</script> 